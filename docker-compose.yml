version: '3'

services:
  broker:
    container_name: mqttBroker
    restart: unless-stopped
    build: ./broker
    volumes:
      - './broker:/usr/src/broker'
      - /usr/src/broker/node_modules
    networks: 
      - smart-garden-net
    environment:
      MONGO_URI: 'mongodb+srv://${MONGO_USERNAME}:${MONGO_PASSWORD}@${MONGO_HOST}/${MONGO_DATABASE}?authSource=admin'
  haproxy:
    container_name: haproxy
    image: mminks/haproxy-docker-logging:latest
    ports:
      - '1883:1883'
      - '8883:8883'
      - '80:80'
    depends_on:
      - dashboard
      - broker
    volumes:
      - './haproxy:/usr/local/etc/haproxy'
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
      - 'web-root:/var/www/next'
    networks:
      - smart-garden-net
  dashboard:
    container_name: dashboard
    build: ./dashboard
    restart: unless-stopped
    volumes:
      - 'web-root:/usr/src/dashboard/packages/server/public'
      - './dashboard:/usr/src/dashboard'
      - /usr/src/dashboard/node_modules
    networks:
      - smart-garden-net
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
      - web-root:/${CERTBOT_WEBROOT}
    depends_on:
      - dashboard
    command: certonly --webroot --webroot-path=/${CERTBOT_WEBROOT} --email ${CERT_MAIL} --agree-tos --no-eff-email --staging -d smartgarden.timweise.com  -d www.smartgarden.timweise.com -d broker.smartgarden.timweise.com

volumes:
  certbot-etc:
  certbot-var:
  web-root:
  

networks: 
  smart-garden-net: